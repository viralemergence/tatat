# Download Docker image to Kamiak with Singularity and convert to Singularity image
mkdir ./src/singularity_image
module load singularity
singularity pull ./src/singularity_image/tatat.sif docker://$DOCKER_USER_ID/transcriptome-assembly-thinning-annotation-tool:latest

# For making scratch space
mkworkspace
export myscratch="$(mkworkspace)"
echo $myscratch
lsworkspace

# Load variables for commands
. ./.env

# Single: SRR2913352
# Paired: SRR2914369

# Test sra_read_download.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $SRA_DOWNLOAD_DIR:/src/data/download_dir \
    --bind $SRA_COLLATE_DIR:/src/data/collate_dir \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/sra_read_download.py \
    -sra_number SRR2914369 \
    -download_dir /src/data/download_dir \
    -collate_dir /src/data/collate_dir \
    -testing

# Test fastp_orchestration.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $SRA_COLLATE_DIR:/src/data/fastq_dir \
    --bind $FASTQ_TRIMMED_DIR:/src/data/trimmed \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/fastp_orchestration.py \
    -i /src/data/fastq_dir \
    -o /src/data/trimmed \
    -u SRR2914369 -r1a $R1_ADAPTER -r2a $R2_ADAPTER --cpus 10

# Test rnaspades_orchestration.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $FASTQ_TRIMMED_DIR:/src/data/trimmed \
    --bind $RNASPADES_ASSEMBLY_DIR:/src/data/assembly \
    --bind $RNASPADES_COLLATED_ASSEMBLY_DIR:/src/data/collated \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/rnaspades_orchestration.py \
    -fastq_dir /src/data/trimmed \
    -assembly_dir /src/data/assembly \
    -collated_dir /src/data/collated \
    -unique_identifier SRR2914369 -cpus 10 -memory 30

# Test kmer_coverage_filtering.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $RNASPADES_COLLATED_ASSEMBLY_DIR:/src/data/collated \
    --bind $KMER_COVERAGE_FILTERED_DIR:/src/data/filtered \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/thinning/kmer_coverage_filtering.py \
    -assembly_path /src/data/collated/SRR2913352.fasta \
    -coverage_cutoff 2 \
    -outdir /src/data/filtered