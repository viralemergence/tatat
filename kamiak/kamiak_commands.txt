# Download Docker image to Kamiak with Singularity and convert to Singularity image
mkdir ./src/singularity_image
module load singularity
singularity pull ./src/singularity_image/tatat.sif docker://$DOCKER_USER_ID/transcriptome-assembly-thinning-annotation-tool:latest

# For making scratch space
mkworkspace
export myscratch="$(mkworkspace)"
echo $myscratch
lsworkspace

# Load variables for commands
. ./.env

# Single: SRR2913352
# Paired: SRR2914369

# Test sra_read_download.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $SRA_DOWNLOAD_DIR:/src/data/download_dir \
    --bind $SRA_COLLATE_DIR:/src/data/collate_dir \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/sra_read_download.py \
    -sra_number SRR2914369 \
    -download_dir /src/data/download_dir \
    -collate_dir /src/data/collate_dir \
    -testing

# Test fastp_orchestration.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $SRA_COLLATE_DIR:/src/data/fastq_dir \
    --bind $FASTQ_TRIMMED_DIR:/src/data/trimmed \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/fastp_orchestration.py \
    -i /src/data/fastq_dir \
    -o /src/data/trimmed \
    -u SRR2914369 -r1a $R1_ADAPTER -r2a $R2_ADAPTER --cpus 10

# Test rnaspades_orchestration.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $FASTQ_TRIMMED_DIR:/src/data/trimmed \
    --bind $RNASPADES_ASSEMBLY_DIR:/src/data/assembly \
    --bind $RNASPADES_COLLATED_ASSEMBLY_DIR:/src/data/collated \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/rnaspades_orchestration.py \
    -fastq_dir /src/data/trimmed \
    -assembly_dir /src/data/assembly \
    -collated_dir /src/data/collated \
    -unique_identifier SRR2914369 -cpus 10 -memory 30

# Test merge_fastas_and_set_metadata.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $RNASPADES_COLLATED_ASSEMBLY_DIR:/src/data/collated \
    --bind $HOST_DATA_DIR/assemblies_and_metadata:/src/data/outdir \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/thinning/merge_fastas_and_set_metadata.py \
    -assembly_fasta_dir /src/data/collated \
    -outdir /src/data/outdir \
    -merged_name raw_transcriptome.fasta \
    -metadata_name transcriptome_metadata.csv

# Test de_novo_assembly_merging.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $KMER_COVERAGE_FILTERED_DIR:/src/data/filtered \
    --bind $RNASPADES_ASSEMBLIES_MERGED:/src/data/merged \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/thinning/de_novo_assembly_merging.py \
    -assembly_fasta_dir /src/data/filtered \
    -outdir /src/data/merged -outname transcriptome_thinned.fasta \
    -cpus 20 -mem 40000 -concat_size 20

# Test evigene_orchestration.py
singularity exec \
    --pwd /src \
    --no-home \
    --env LC_ALL=C \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_DIR/assemblies_and_metadata:/src/data/transcripts \
    --bind $EVIGENE_OUTPUT_DIR:/src/data/evigene_output \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/thinning/evigene_orchestration.py \
    -assembly_fasta /src/data/transcripts/raw_transcriptome.fasta \
    -outdir /src/data/evigene_output \
    -metadata /src/data/transcripts/transcriptome_metadata.csv \
    -cpus 9 -mem 25000 -run_evigene

# Test kmer_coverage_filtering.py
singularity exec \
    --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_DIR/assemblies_and_metadata:/src/data/transcripts \
    --bind $HOST_DATA_DIR/kmer_qc:/src/data/kmer_qc \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/thinning/kmer_coverage_qc.py \
    -metadata /src/data/transcripts/transcriptome_metadata.csv \
    -coverage_cutoff 1.5 \
    -update_kmer_coverage_pass \
    -qc_dir /src/data/kmer_qc